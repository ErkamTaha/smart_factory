services:
  # PostgreSQL Database
  postgres:
    image: postgres:15
    container_name: smartfactory_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: smartfactory
      POSTGRES_USER: smartfactory
      POSTGRES_PASSWORD: password123
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - smartfactory_net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U smartfactory -d smartfactory" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # EMQX MQTT Broker (Replaced Mosquitto)
  emqx:
    image: emqx/emqx:5.5.0
    container_name: smartfactory_emqx
    hostname: smartfactory_emqx
    restart: unless-stopped
    ports:
      - "1883:1883" # MQTT TCP
      - "8083:8083" # MQTT WebSocket
      - "8883:8883" # MQTT SSL/TLS
      - "18083:18083" # Dashboard & HTTP API
    environment:
      - EMQX_LISTENERS__SSL__DEFAULT__BIND=0.0.0.0:8883
      - EMQX_LISTENERS__SSL__DEFAULT__SSL_OPTIONS__CERTFILE=/opt/emqx/etc/certs/server.crt
      - EMQX_LISTENERS__SSL__DEFAULT__SSL_OPTIONS__KEYFILE=/opt/emqx/etc/certs/server.key
      - EMQX_LISTENERS__SSL__DEFAULT__SSL_OPTIONS__CACERTFILE=/opt/emqx/etc/certs/ca.crt
      - EMQX_LISTENERS__SSL__DEFAULT__SSL_OPTIONS__VERIFY=verify_none
      - EMQX_LISTENERS__SSL__DEFAULT__SSL_OPTIONS__FAIL_IF_NO_PEER_CERT=false

      - EMQX_LISTENERS__WSS__DEFAULT__BIND=0.0.0.0:8084
      - EMQX_LISTENERS__WSS__DEFAULT__SSL_OPTIONS__CERTFILE=/opt/emqx/etc/certs/server.crt
      - EMQX_LISTENERS__WSS__DEFAULT__SSL_OPTIONS__KEYFILE=/opt/emqx/etc/certs/server.key

      # Dashboard credentials
      - EMQX_DASHBOARD__DEFAULT_USERNAME=admin
      - EMQX_DASHBOARD__DEFAULT_PASSWORD=smartfactory_admin_2024

      # Security settings
      - EMQX_ALLOW_ANONYMOUS=false

      # Node name
      - EMQX_NODE__NAME=emqx@smartfactory_emqx
      - EMQX_NODE__COOKIE=secret_cookie

      # Log level
      - EMQX_LOG__CONSOLE__LEVEL=info

      # Listeners
      - EMQX_LISTENERS__TCP__DEFAULT__BIND=0.0.0.0:1883
      - EMQX_LISTENERS__WS__DEFAULT__BIND=0.0.0.0:8083
    volumes:
      - emqx_data:/opt/emqx/data
      - emqx_log:/opt/emqx/log
      - ./certs/ca.crt:/opt/emqx/etc/certs/ca.crt
      - ./certs/server.crt:/opt/emqx/etc/certs/server.crt
      - ./certs/server.key:/opt/emqx/etc/certs/server.key
    networks:
      - smartfactory_net
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep -v grep | grep -q 'emqx.*-name emqx@' || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: smartfactory_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - smartfactory_net
    command: redis-server --appendonly yes --requirepass redis123
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development
    container_name: smartfactory_backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # Database
      - DATABASE_URL=postgresql+asyncpg://smartfactory:password123@postgres:5432/smartfactory

      # MQTT/EMQX Configuration
      - MQTT_BROKER_HOST=emqx
      - MQTT_BROKER_PORT=8883
      - MQTT_TLS_ENABLED=true

      # EMQX HTTP API Configuration
      - EMQX_API_URL=http://emqx:18083
      - EMQX_API_KEY=admin
      - EMQX_API_SECRET=smartfactory_admin_2024

      # Redis
      - REDIS_URL=redis://redis:6379

      # Application
      - ENVIRONMENT=development
      - DEBUG=true
      - LOG_LEVEL=INFO

      # Security
      - SECRET_KEY=your-secret-key-change-in-production
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
    volumes:
      - ./backend:/app
      - backend_logs:/app/logs
      - ./certs/ca.crt:/app/certs/ca.crt:ro
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app --reload-dir /app/app
    networks:
      - smartfactory_net
    depends_on:
      postgres:
        condition: service_healthy
      emqx:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend Web App
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
    container_name: smartfactory_frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - VITE_API_BASE_URL=http://localhost:8000
      - VITE_WS_URL=wss://localhost:8084
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=200
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - smartfactory_net
    depends_on:
      - backend
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # pgAdmin - PostgreSQL Web Interface
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: smartfactory_pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@smartfactory.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - smartfactory_net
    depends_on:
      - postgres

volumes:
  postgres_data:
    driver: local
  emqx_data:
    driver: local
  emqx_log:
    driver: local
  redis_data:
    driver: local
  backend_logs:
    driver: local
  pgadmin_data:
    driver: local

networks:
  smartfactory_net:
    driver: bridge
    name: smartfactory_network
    ipam:
      config:
        - subnet: 172.20.0.0/16
